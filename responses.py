# Dictionary of keywords and their corresponding responses
KEYWORD_RESPONSES = {
    # English keywords and responses
    "hello": "Hello there! How can I help you?",
    "hi": "Hi! How are you doing?",
    "help": "If you need help, you can use the /help command.",
    "thank you": "You're welcome!",
    "thanks": "You're welcome!",
    "rules": "Please read the group rules pinned in the group.",
    "group rules": "The group rules can be found in the pinned messages.",
    
    # åŸºæœ¬é—®å€™å’Œå›å¤
    "ä½ å¥½": "ä½ å¥½å‘€ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®å¿™çš„å—ï¼Ÿ",
    "å—¨": "å—¨ï¼ä½ å¥½å—ï¼Ÿ",
    "æ—©ä¸Šå¥½": "æ—©ä¸Šå¥½ï¼ç¥ä½ æœ‰ä¸ªç¾å¥½çš„ä¸€å¤©~",
    "ä¸­åˆå¥½": "ä¸­åˆå¥½ï¼è®°å¾—åƒåˆé¥­å“¦~",
    "æ™šä¸Šå¥½": "æ™šä¸Šå¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ",
    "æ™šå®‰": "æ™šå®‰ï¼ç¥ä½ æœ‰ä¸ªç”œç¾çš„æ¢¦~",
    "æ–°å¹´å¿«ä¹": "æ–°å¹´å¿«ä¹ï¼ç¥ä½ åœ¨æ–°çš„ä¸€å¹´é‡Œä¸‡äº‹å¦‚æ„ï¼",
    "å…ƒæ—¦å¿«ä¹": "å…ƒæ—¦å¿«ä¹ï¼æ–°çš„ä¸€å¹´ï¼Œæ–°çš„å¼€å§‹ï¼",
    "æ˜¥èŠ‚å¿«ä¹": "æ˜¥èŠ‚å¿«ä¹ï¼æ­å–œå‘è´¢ï¼Œçº¢åŒ…æ‹¿æ¥ï¼ğŸ§§",
    
    # å¸®åŠ©ç›¸å…³
    "å¸®åŠ©": "å¦‚æœä½ éœ€è¦å¸®åŠ©ï¼Œå¯ä»¥ä½¿ç”¨ /help å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤ã€‚",
    "ä½¿ç”¨è¯´æ˜": "ä½¿ç”¨ /help å‘½ä»¤å¯ä»¥æŸ¥çœ‹æœºå™¨äººçš„æ‰€æœ‰åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ã€‚",
    "æ€ä¹ˆç”¨": "ä½ å¯ä»¥ä½¿ç”¨ /help å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰åŠŸèƒ½ï¼Œæˆ–è€…ç›´æ¥é—®æˆ‘å…·ä½“é—®é¢˜ã€‚",
    "åŠŸèƒ½": "æœ¬æœºå™¨äººæä¾›ç¾¤ç»„ç®¡ç†ã€ä¿¡æ¯æŸ¥è¯¢ã€è‡ªåŠ¨å›å¤ç­‰åŠŸèƒ½ï¼Œä½¿ç”¨ /help æŸ¥çœ‹è¯¦æƒ…ã€‚",
    
    # æ„Ÿè°¢ç”¨è¯­
    "è°¢è°¢": "ä¸å®¢æ°”ï¼Œå¾ˆé«˜å…´èƒ½å¸®åˆ°ä½ ï¼",
    "æ„Ÿè°¢": "ä¸å®¢æ°”ï¼",
    "å¤ªæ£’äº†": "è°¢è°¢å¤¸å¥–ï¼Œæˆ‘ä¼šç»§ç»­åŠªåŠ›çš„ï¼",
    "å¥½ç”¨": "è°¢è°¢ï¼æˆ‘ä»¬ä¸€ç›´åœ¨åŠªåŠ›æ”¹è¿›~",
    
    # ç¾¤ç»„è§„åˆ™
    "è§„åˆ™": "è¯·é˜…è¯»ç¾¤ç»„å†…ç½®é¡¶çš„ç¾¤ç»„è§„åˆ™ã€‚è¿åè§„åˆ™å¯èƒ½ä¼šè¢«è­¦å‘Šæˆ–å°ç¦ã€‚",
    "ç¾¤è§„": "ç¾¤ç»„è§„åˆ™å¯ä»¥åœ¨ç½®é¡¶æ¶ˆæ¯ä¸­æ‰¾åˆ°ã€‚è¯·å¤§å®¶å…±åŒç»´æŠ¤è‰¯å¥½çš„ç¾¤ç»„ç¯å¢ƒï¼",
    "ç¦è¨€": "è¿åç¾¤è§„çš„ç”¨æˆ·å¯èƒ½ä¼šè¢«ç¦è¨€ï¼Œè¯·å¤§å®¶æ–‡æ˜å‘è¨€ï¼Œå…±åŒç»´æŠ¤è‰¯å¥½çš„äº¤æµç¯å¢ƒã€‚",
    "ä¸¾æŠ¥": "å¦‚æœå‘ç°æœ‰äººè¿åç¾¤è§„ï¼Œè¯·è”ç³»ç¾¤ç»„ç®¡ç†å‘˜è¿›è¡Œä¸¾æŠ¥ã€‚",
    
    # ç¾¤ç»„ä¿¡æ¯
    "ç¾¤ç»„ä¿¡æ¯": "ä½¿ç”¨ /stats å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ç¾¤ç»„çš„è¯¦ç»†ä¿¡æ¯ã€‚",
    "ç¾¤ç»Ÿè®¡": "ä½¿ç”¨ /stats å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç¾¤ç»„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æˆå‘˜æ•°é‡ç­‰æ•°æ®ã€‚",
    "æ´»åŠ¨": "ç¾¤ç»„æ´»åŠ¨ä¿¡æ¯ä¼šå®šæœŸåœ¨å…¬å‘Šä¸­å‘å¸ƒï¼Œè¯·ç•™æ„ç½®é¡¶æ¶ˆæ¯ã€‚",
    "ç®¡ç†å‘˜": "å¦‚éœ€è”ç³»ç®¡ç†å‘˜ï¼Œè¯·åœ¨æ¶ˆæ¯ä¸­@ç®¡ç†å‘˜æˆ–ç§ä¿¡ä»–ä»¬ã€‚",
    
    # æœºå™¨äººç›¸å…³
    "æœºå™¨äºº": "æˆ‘æ˜¯ä¸€ä¸ªç¾¤ç®¡ç†æœºå™¨äººï¼Œå¯ä»¥å¸®åŠ©ç®¡ç†ç¾¤ç»„ã€å›ç­”é—®é¢˜å’Œæä¾›å„ç§æœåŠ¡ã€‚",
    "æŒ‡ä»¤": "ä½¿ç”¨ /help å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æŒ‡ä»¤åˆ—è¡¨ã€‚",
    "å‘½ä»¤": "æˆ‘æ”¯æŒå¤šç§å‘½ä»¤ï¼Œå¦‚ /start, /help, /ban, /stats ç­‰ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹ /helpã€‚",
    
    # å…¶ä»–å¸¸è§é—®é¢˜
    "æ€ä¹ˆåŠ å…¥": "æƒ³åŠ å…¥æœ¬ç¾¤ç»„ï¼Œè¯·è”ç³»ç¾¤ç»„ç®¡ç†å‘˜è·å–é‚€è¯·é“¾æ¥ã€‚",
    "å¤ªå®‰é™äº†": "æ˜¯æœ‰ç‚¹å®‰é™å‘¢ï¼Œä¸å¦‚åˆ†äº«ä¸€äº›æœ‰è¶£çš„è¯é¢˜ï¼Œæ´»è·ƒä¸€ä¸‹ç¾¤ç»„æ°›å›´å§ï¼",
    "é—²èŠ": "é—²èŠæ˜¯å…è®¸çš„ï¼Œä½†è¯·éµå®ˆç¾¤è§„ï¼Œä¿æŒå‹å–„å’Œå°Šé‡ã€‚",
    "ç¬‘è¯": "æŠ±æ­‰ï¼Œæˆ‘ä¸ä¼šè®²ç¬‘è¯ï¼Œä½†ä½ å¯ä»¥åœ¨ç¾¤é‡Œåˆ†äº«æœ‰è¶£çš„äº‹æƒ…ï¼"
}

from typing import Optional, Dict
import logging

# å¯¼å…¥é…ç½®ä¸­çš„é¢å¤–å…³é”®è¯å›å¤
try:
    from config import ADDITIONAL_KEYWORD_RESPONSES
except ImportError:
    logging.warning("Could not import ADDITIONAL_KEYWORD_RESPONSES from config.py")
    ADDITIONAL_KEYWORD_RESPONSES = {}

# åˆå¹¶åŸºç¡€å…³é”®è¯å’Œé…ç½®æ–‡ä»¶ä¸­çš„é¢å¤–å…³é”®è¯
ALL_KEYWORD_RESPONSES: Dict[str, str] = {**KEYWORD_RESPONSES, **ADDITIONAL_KEYWORD_RESPONSES}

def get_response_for_keyword(message_text: str) -> Optional[str]:
    """
    æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«ä»»ä½•å…³é”®è¯å¹¶è¿”å›ç›¸åº”çš„å›å¤ã€‚
    ä¼˜å…ˆä»æ•°æ®åº“ä¸­è·å–å…³é”®è¯å›å¤ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æˆ–è€…æ•°æ®åº“è®¿é—®å‡ºé”™ï¼Œåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å…³é”®è¯ã€‚
    
    Args:
        message_text: è¦æ£€æŸ¥å…³é”®è¯çš„æ–‡æœ¬æ¶ˆæ¯ã€‚
        
    Returns:
        æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªå…³é”®è¯çš„å›å¤ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å…³é”®è¯åˆ™è¿”å› Noneã€‚
    """
    if not message_text:
        return None
        
    message_lower = message_text.lower()
    
    # å°è¯•ä»æ•°æ®åº“ä¸­è·å–å…³é”®è¯å›å¤
    try:
        # å¯¼å…¥æ•°æ®åº“æ¨¡å‹
        from app import app
        with app.app_context():
            from models import KeywordResponse
            
            # è·å–æ‰€æœ‰æ´»è·ƒçš„å…³é”®è¯å“åº”
            keyword_responses = KeywordResponse.query.filter_by(is_active=True).all()
            
            # ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•æ•°æ®åº“ä¸­çš„å…³é”®è¯
            for kr in keyword_responses:
                if kr.keyword.lower() in message_lower:
                    logging.debug(f"ä»æ•°æ®åº“åŒ¹é…åˆ°å…³é”®è¯ '{kr.keyword}'")
                    return kr.response
    except Exception as e:
        # å¦‚æœæ•°æ®åº“è®¿é—®å‡ºé”™ï¼Œè®°å½•é”™è¯¯å¹¶å›é€€åˆ°é…ç½®æ–‡ä»¶
        logging.warning(f"æ•°æ®åº“å…³é”®è¯æŸ¥è¯¢å¤±è´¥: {str(e)}, ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å…³é”®è¯")
    
    # å¦‚æœæ²¡æœ‰ä»æ•°æ®åº“åŒ¹é…åˆ°ï¼Œæˆ–è€…å‡ºç°å¼‚å¸¸ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å…³é”®è¯
    for keyword, response in ALL_KEYWORD_RESPONSES.items():
        if keyword.lower() in message_lower:
            logging.debug(f"ä»é…ç½®æ–‡ä»¶åŒ¹é…åˆ°å…³é”®è¯ '{keyword}'")
            return response
            
    return None
